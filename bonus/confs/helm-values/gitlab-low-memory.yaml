# GitLab configuration optimized for low memory (6GB RAM)
# With limits to prevent OOM and environment crashes

global:
  ingress:
    configureCertmanager: false
    class: "traefik"
  hosts:
    domain: localhost
    externalIP: 0.0.0.0
    https: false
  rails:
    bootsnap:
      enabled: false

# Don't use certmanager
installCertmanager: false

# Don't use nginx-ingress (using Traefik)
nginx-ingress:
  enabled: false

# Disable Prometheus (saves ~500MB)
prometheus:
  install: false

# Disable GitLab Runner (saves ~200MB)
gitlab-runner:
  install: false

# Minimal replicas with controlled limits
gitlab:
  webservice:
    minReplicas: 1
    maxReplicas: 1
    # Single worker to minimize memory usage
    workerProcesses: 1
    resources:
      requests:
        memory: 200Mi
        cpu: 200m
      limits:
        memory: 1.5Gi  # 1 worker needs ~1.25GB + overhead
        cpu: 1000m
    puma:
      workerMaxMemory: 1200  # MB - restart worker if exceeds
      threads:
        min: 1
        max: 4

  sidekiq:
    minReplicas: 1
    maxReplicas: 1
    resources:
      requests:
        memory: 100Mi
        cpu: 100m
      limits:
        memory: 900Mi  # Controlled limit for background jobs
        cpu: 500m
    # Reduce concurrency to save memory
    concurrency: 10

  gitlab-shell:
    minReplicas: 1
    maxReplicas: 1
    resources:
      requests:
        memory: 50Mi
        cpu: 50m
      limits:
        memory: 150Mi  # Small but safe limit
        cpu: 200m

  gitaly:
    resources:
      requests:
        memory: 100Mi
        cpu: 100m
      limits:
        memory: 700Mi  # Git operations can spike
        cpu: 500m

# Registry with minimal resources
registry:
  hpa:
    minReplicas: 1
    maxReplicas: 1
  resources:
    requests:
      memory: 50Mi
      cpu: 50m
    limits:
      memory: 150Mi
      cpu: 200m

# PostgreSQL with reduced resources
postgresql:
  primary:
    resources:
      requests:
        memory: 200Mi
        cpu: 100m
      limits:
        memory: 600Mi  # Database needs reasonable limit
        cpu: 500m
    # Optimize PostgreSQL for low memory
    extendedConfiguration: |
      shared_buffers = 128MB
      effective_cache_size = 256MB
      maintenance_work_mem = 64MB
      work_mem = 8MB
      max_connections = 20
      max_wal_size = 512MB
      min_wal_size = 80MB

# Redis with minimal resources
redis:
  master:
    resources:
      requests:
        memory: 100Mi
        cpu: 50m
      limits:
        memory: 300Mi
        cpu: 200m

# MinIO with minimal resources
minio:
  resources:
    requests:
      memory: 100Mi
      cpu: 50m
    limits:
      memory: 256Mi
      cpu: 200m

# Migrations job
gitlab:
  migrations:
    resources:
      requests:
        memory: 100Mi
        cpu: 50m
      limits:
        memory: 400Mi
        cpu: 200m

# Shared secrets job
shared-secrets:
  resources:
    requests:
      memory: 50Mi
      cpu: 50m
    limits:
      memory: 100Mi
      cpu: 100m
